<form [formGroup]="parentFormGroup" (ngSubmit)="submit()">
    <mat-form-field appearance="standard" *ngIf="hasFilter">
        <mat-label>Filter</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Filter values..." #input>
    </mat-form-field>
    <table
        mat-table
        [dataSource]="matTableDataSource"
        class="mat-elevation-z8"
        formArrayName="parentFormFormArray"
        multiTemplateDataRows>
        
        <ng-container matColumnDef="select" *ngIf="rowSelection">
            <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox
                    (change)="onMasterToggleSelectionChange($event)"
                    [checked]="selection.hasValue() && isAllSelected()"
                    [indeterminate]="selection.hasValue() && !isAllSelected()"
                    [aria-label]="checkboxLabel()">
                </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row; let rowIndex = dataIndex">
                <mat-checkbox
                    (click)="$event.stopPropagation()"
                    (change)="onRowSelectionChange($event, row, rowIndex)"
                    [checked]="selection.isSelected(row)"
                    [aria-label]="checkboxLabel(row, rowIndex)">
                </mat-checkbox>
            </td>
        </ng-container>
        
        <ng-container matColumnDef="{{displayCol.name}}" *ngFor="let displayCol of displayColumns">
            <th mat-header-cell *matHeaderCellDef [hidden]="!displayCol.isVisible">{{displayCol.displayName}}</th>
            <td
                mat-cell
                *matCellDef="let row; let rowIndex = dataIndex"
                [hidden]="!displayCol.isVisible"
                [formGroupName]="rowIndex">
                    <ng-container [ngSwitch]="displayCol.propertyType" *ngIf="!displayCol.isEditable">
                        <ng-container *ngSwitchCase="'text'">{{row.get(displayCol.name).value}}</ng-container>
                        <ng-container *ngSwitchCase="'number'">{{row.get(displayCol.name).value}}</ng-container>
                        <mat-checkbox
                            *ngSwitchCase="'boolean'"
                            (click)="$event.stopPropagation()"
                            [formControlName]="displayCol.name"
                            [disabled]="true">
                        </mat-checkbox>
                        <ng-container
                            *ngSwitchCase="'select'">
                            {{ dataGridHelperService.getSelectedDisplayValue(row[displayCol.name], displayCol.name, selectColumnMappingModels) }}
                        </ng-container>
                    </ng-container>
                    <ng-container [ngSwitch]="displayCol.propertyType" *ngIf="displayCol.isEditable">
                        <mat-form-field floatLabel="never" *ngSwitchCase="'text'">
                            <input matInput type="text" placeholder="{{displayCol.displayName}}" [formControlName]="displayCol.name">
                        </mat-form-field>
                        <mat-form-field floatLabel="never" *ngSwitchCase="'number'">
                            <input matInput type="number" placeholder="{{displayCol.displayName}}" [formControlName]="displayCol.name">
                        </mat-form-field>
                        <mat-checkbox *ngSwitchCase="'boolean'" (click)="$event.stopPropagation()" [formControlName]="displayCol.name">
                        </mat-checkbox>
                        <mat-form-field *ngSwitchCase="'date'" appearance="fill">
                            <mat-label>Choose a date</mat-label>
                            <input matInput [matDatepicker]="picker" [formControlName]="displayCol.name">
                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                        </mat-form-field>
                        <mat-form-field *ngSwitchCase="'select'">
                            <mat-select
                                [formControlName]="displayCol.name"
                                placeholder="Select from values"
                                (click)="$event.stopPropagation()">
                                    <mat-option *ngFor="let option of dataGridHelperService.getOptionsForColumn(displayCol.name, selectColumnMappingModels)" [value]="option.key">
                                    {{ option.displayValue }}
                                    </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </ng-container>
            </td>
        </ng-container>

        <ng-container matColumnDef="{{expandedDetailFormControlName}}">
            <td mat-cell *matCellDef="let rowElement; let rowIndex = dataIndex" [formGroupName]="rowIndex" [attr.colspan]="columnsProps.length">
                <div
                    class="element-detail"
                    *ngIf="rowElement.get(expandedDetailFormControlName)?.value[expandedDetailFormControlName]?.length"
                    [@detailExpand]="rowElement == expandedElement ? 'expanded' : 'collapsed'">
                        <app-row-details
                            class="inner-table"
                            [hidden]="!expandedElement"
                            formControlName="{{expandedDetailFormControlName}}"
                            [innerDisplayColumns]="innerDisplayColumns"
                            [subrowArrayPropName]="subrowArrayPropName"
                            [selectInnerColumnMappingModels]="selectInnerColumnMappingModels"
                            [subrowSelection]="subrowSelection"
                            [masterRowIndex]="rowIndex"
                            [onMainRowSelected]="mainRowSelectedObj"
                            (onSelectSubrow)="toggleSubrowSelection($event)">
                        </app-row-details>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columnsProps"></tr>
        <tr
            mat-row
            *matRowDef="let rowElement; columns: columnsProps;"
            [class.element-row]="rowElement[expandedDetailFormControlName]?.length"
            [class.expanded-row]="expandedElement === rowElement"
            (click)="toggleExpandRow(rowElement)">
        </tr>
        <tr mat-row *matRowDef="let row; columns: [expandedDetailFormControlName]" class="detail-row" ></tr>
    </table>
    <button *ngIf="isFormEditable" mat-raised-button type="submit" color="primary" class="submit-button">Submit</button>
</form>